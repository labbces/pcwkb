{% extends "base.html" %}
{% load static %}

{% block content %}

{% if scientific_name %}

<div class="container-fluid px-4 py-3">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb rounded-pill px-3 border border-success pcwkb-bg-color">
      <li class="breadcrumb-item"><a href="pcwkb_core">Home</a></li>
      <li class="breadcrumb-item"><a href="pcwkb_core/browse_species">Species</a></li>
      <li class="breadcrumb-item active" aria-current="page"><i>{{ scientific_name }}</i></li>
    </ol>
  </nav>
</div>

<header class="py-3 py-md-5 py-xl-8">
  <div class="container">
    <div class="row justify-content-md-center">
      <div class="col-12 col-md-10 col-lg-8 col-xl-7 col-xxl-6">
        <h2 class="mb-4 display-5 text-center"><i>{{ scientific_name }}</i></h2>
        <hr class="w-50 mx-auto mb-5 mb-xl-9 border-success-subtle">
        {% if common_name %}
        <h4 class="text-secondary mb-5 text-center"> Common Name: {{ common_name }} <br> Species Code: {{ species_code }} </h4>
        {% else %}
        <h4 class="text-secondary mb-5 text-center"> Species Code: {{ species_code }} </h4>
        {% endif %}
        {%if photosystem%}
        <h4 class="text-secondary mb-5 text-center"> Photosystem: {{ photosystem }} </h4>
        {%endif%}
      </div>
    </div>
  </div>
</header>

{% endif %} 

{% if wikipedia_content %}
<div class="py-4 rounded-5 pcwkb-bg-color m-4">
  <div class="card border-success mx-4 rounded-4">
    <div class="row g-0">
      <div class="col-md-2">
        <img src="{{ wikipedia_content.thumbnail.source|safe }}" style="height: 300px" class="img-fluid rounded-start-4" alt="{{ scientific_name }}">
      </div>
      <div class="col-md-10">
        <div class="card-body">
          <h5 class="card-header">Description (Wikipedia)</h5>
          <p class="card-text">{{ wikipedia_content.extract_html|safe }}</p>
        </div>
        <div class="card-body">
          <p class="card-text"><small class="text-body-secondary"><a href="{{ wikipedia_content.content_urls.desktop.page|safe }}">See more on Wikipedia</a></small></p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="py-4 rounded-5 pcwkb-bg-color m-4">
  <div class="card border-success mx-4 rounded-4">
    <h5 class="card-header"> General information </h5>
    <div class="card-body">
      <p class="card-text"> Genes count: {{ genes_count }} </p>
      <p class="card-text"> Experiments count: {{ experiments_count }} </p>
    </div>
  </div>
</div>

{% if biomass_composition %}

  {{ biomass_composition|json_script:"biomass_composition" }}
  <div class="mx-auto w-75">
  <script>
    const scientificName = '{{ scientific_name }}'
    const biomasscomp = JSON.parse(document.getElementById('biomass_composition').textContent);
  </script>
  <div id="grafico" class="overflow-auto"></div>
    <p class="d-flex justify-content-end">ReferÃªncia: <a href="https://doi.org/{{biomass_composition_literature.doi}}" target="_blank">"{{ biomass_composition_literature.title }}"</a></p>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script src="{% static 'script/species/species_plotyheatmap.js' %}"></script>
</div>
{% else %}
<div class="row justify-content-md-center">
  <h4 class="text-secondary mb-5 text-center"> Species without biomass composition data </h4>
</div>
{% endif %}



<section class="container p-4 mt-4 border border-success rounded-5" style="background-color:#88b993" id="genes_section">
  <h3 class="text-center text-white">Plant Cell Wall related genes</h3>

  {% if genes_biomass_assoc %}
  <div class="border border-success rounded-2 p-2 m-4" style="background-color: white">
    <h4 class="text-center m-4">Genes involved in biomass-related experiments</h4>
    <table class="table table-striped table-responsive" text-align="center" id="gene-biomass-table">
      <thead> 
        <tr>
          <th scope="col">Gene ID</th>
          <th scope="col">Gene Name</th>
          <th scope="col">Description</th>
          <th scope="col">Chemical entity</th>
          <th scope="col">Experiments</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <nav aria-label="Gene navigation">
      <ul class="pagination justify-content-center d-flex flex-wrap" id="pagination-links">
      </ul>
    </nav>
  </div>

  {% endif %}

  {% if genes_interaction_assoc %}
  <div class="border border-success rounded-2 p-2 m-4" style="background-color: white">
    <h4 class="text-center m-4">Genes involved in gene interaction experiments</h4>
    <table class="table table-striped table-responsive" text-align="center" id="gene-interaction-table">
      <thead> 
        <tr>
          <th scope="col">Putative Gene Regulator ID</th>
          <th scope="col">Gene Target</th>
          <th scope="col">Effect on Target</th>
          <th scope="col">Experiments</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <nav aria-label="Gene navigation">
      <ul class="pagination justify-content-center d-flex flex-wrap" id="pagination-links">
      </ul>
    </nav>
  </div>

  {% endif %}

  {% if genes_paginated %}
    <div class="border border-success rounded-2 p-2 m-4" style="background-color: white">
      <h4 class="text-center m-4">Genes</h4>
      <table class="table table-striped table-responsive" text-align="center" id="data-table">
        <thead>
          <tr>
            <th scope="col">Gene ID</th>
            <th scope="col">Gene Name</th>
            <th scope="col">Description</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <nav aria-label="Gene navigation">
        <ul class="pagination justify-content-center d-flex flex-wrap" id="pagination-links2">
        </ul>
      </nav>
    </div>

  {% else %}

    <div class="border border-success rounded-2 p-2 m-4" style="background-color: white">
      <h4 class="text-center m-4">No genes found for this species.</h4>
    </div>

  {% endif %}

</section>

<style>
  .pagination{
    --bs-pagination-active-bg: green;
    --bs-pagination-active-border-color: green;
    --bs-pagination-hover-color: white;
  }
  .page-link {
    width: 3rem;
    text-align: center;
    font-size: 0.9rem;
    color: green;
  }

  .page-link:hover {
    background-color: darkgreen;
    border-color: darkgreen;
    text-color: white
  }

  .page-link:focus {
    box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
  }
</style>

<script>
  function loadTableData(page) {
    fetch(`/pcwkb_core/gene_biomass_list/{{ species_id }}?page=${page}`)
      .then(response => response.json())
      .then(data => {
        const tableBody = document.getElementById('gene-biomass-table').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = '';  // Clear current table data

        data.data.forEach(rowData => {
          const row = tableBody.insertRow();
          const cell1 = row.insertCell(0);
          cell1.innerHTML = `<a href="pcwkb_core/gene_page/${rowData.gene_name}">${rowData.gene_id}</a>`;
          const cell2 = row.insertCell(1);
          cell2.innerHTML =  `<a href="pcwkb_core/gene_page/${rowData.gene_name}">${rowData.gene_name}</a>`;
          const cell3 = row.insertCell(2);
          cell3.innerHTML = rowData.description;
          const cell4 = row.insertCell(3);
          cell4.innerHTML = `<a href="/pcwkb_core/cellwallcomponent_page/${rowData.chebi}">${rowData.chebi}</a>`;
          const cell5 = row.insertCell(4);
          cell5.innerHTML = rowData.experiment_count;
        });

        // Handle pagination links
        const paginationLinks = document.getElementById('pagination-links');
        paginationLinks.innerHTML = '';  // Clear current pagination links

        const maxPagesToShow = 5;  // Maximum number of page links to show
        let startPage = Math.max(1, page - Math.floor(maxPagesToShow / 2));
        let endPage = startPage + maxPagesToShow - 1;

        if (endPage > data.num_pages) {
          endPage = data.num_pages;
          startPage = Math.max(1, endPage - maxPagesToShow + 1);
        }

        // Frist page link
        const firstPageItem = document.createElement('li');
        firstPageItem.className = 'page-item';
        firstPageItem.innerHTML = `<a class="page-link" href="?page=1" aria-label="First">First</a>`;
        if (page > 1) {
          firstPageItem.addEventListener('click', (event) => {
            event.preventDefault();
            loadTableData(1);
          });
        } else {
          firstPageItem.classList.add('disabled');
        }
        paginationLinks.appendChild(firstPageItem);

        // Previous page link
        const prevPageItem = document.createElement('li');
        prevPageItem.className = 'page-item';
        prevPageItem.innerHTML = `
          <a class="page-link" href="?page=${page - 1}" aria-label="Previous">
            <span aria-hidden="true">&laquo;</span>
          </a>`;
        if (page > 1) {
          prevPageItem.addEventListener('click', (event) => {
            event.preventDefault();
            loadTableData(page - 1);
          });
        } else {
          prevPageItem.classList.add('disabled');
        }
        paginationLinks.appendChild(prevPageItem);

        // Page number links
        for (let i = startPage; i <= endPage; i++) {
          const pageItem = document.createElement('li');
          pageItem.className = `page-item ${i === page ? 'active disabled' : ''}`;
          pageItem.innerHTML = `<a class="page-link" href="?page=${i}">${i}</a>`;
          if (i !== page) {
            pageItem.addEventListener('click', (event) => {
              event.preventDefault();
              loadTableData(i);
            });
          }
          paginationLinks.appendChild(pageItem);
        }

        // Next page link
        const nextPageItem = document.createElement('li');
        nextPageItem.className = 'page-item';
        nextPageItem.innerHTML = `
          <a class="page-link" href="?page=${page + 1}" aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
          </a>`;
        if (page < data.num_pages) {
          nextPageItem.addEventListener('click', (event) => {
            event.preventDefault();
            loadTableData(page + 1);
          });
        } else {
          nextPageItem.classList.add('disabled');
        }
        paginationLinks.appendChild(nextPageItem);

        // Last page link
        const lastPageItem = document.createElement('li');
        lastPageItem.className = 'page-item';
        lastPageItem.innerHTML = `<a class="page-link" href="?page=${data.num_pages}" aria-label="Last">Last</a>`;
        if (page < data.num_pages) {
          lastPageItem.addEventListener('click', (event) => {
            event.preventDefault();
            loadTableData(data.num_pages);
          });
        } else {
          lastPageItem.classList.add('disabled');
        }
        paginationLinks.appendChild(lastPageItem);
      });
  }

  // Load first page on page load
  loadTableData(1);

</script>

<script>
  function loadTableData(page) {
    fetch(`/pcwkb_core/gene_interaction_list/{{ species_id }}?page=${page}`)
      .then(response => response.json())
      .then(data => {
        const tableBody = document.getElementById('gene-interaction-table').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = '';  // Clear current table data

        data.data.forEach(rowData => {
          console.log(rowData.putative_gene_regulator)
          const row = tableBody.insertRow();
          const cell1 = row.insertCell(0);
          cell1.innerHTML = `<a href="pcwkb_core/gene_page/${rowData.putative_gene_regulator}">${rowData.putative_gene_regulator}</a>`;
          const cell2 = row.insertCell(1);
          cell2.innerHTML =  `<a href="pcwkb_core/gene_page/${rowData.gene_target}">${rowData.gene_target}</a>`;
          const cell3 = row.insertCell(2);
          cell3.innerHTML = rowData.effect_on_target;
          const cell4 = row.insertCell(3);
          cell4.innerHTML = rowData.experiment_count;
        });

        // Handle pagination links
        const paginationLinks = document.getElementById('pagination-links');
        paginationLinks.innerHTML = '';  // Clear current pagination links

        const maxPagesToShow = 5;  // Maximum number of page links to show
        let startPage = Math.max(1, page - Math.floor(maxPagesToShow / 2));
        let endPage = startPage + maxPagesToShow - 1;

        if (endPage > data.num_pages) {
          endPage = data.num_pages;
          startPage = Math.max(1, endPage - maxPagesToShow + 1);
        }

        // Frist page link
        const firstPageItem = document.createElement('li');
        firstPageItem.className = 'page-item';
        firstPageItem.innerHTML = `<a class="page-link" href="?page=1" aria-label="First">First</a>`;
        if (page > 1) {
          firstPageItem.addEventListener('click', (event) => {
            event.preventDefault();
            loadTableData(1);
          });
        } else {
          firstPageItem.classList.add('disabled');
        }
        paginationLinks.appendChild(firstPageItem);

        // Previous page link
        const prevPageItem = document.createElement('li');
        prevPageItem.className = 'page-item';
        prevPageItem.innerHTML = `
          <a class="page-link" href="?page=${page - 1}" aria-label="Previous">
            <span aria-hidden="true">&laquo;</span>
          </a>`;
        if (page > 1) {
          prevPageItem.addEventListener('click', (event) => {
            event.preventDefault();
            loadTableData(page - 1);
          });
        } else {
          prevPageItem.classList.add('disabled');
        }
        paginationLinks.appendChild(prevPageItem);

        // Page number links
        for (let i = startPage; i <= endPage; i++) {
          const pageItem = document.createElement('li');
          pageItem.className = `page-item ${i === page ? 'active disabled' : ''}`;
          pageItem.innerHTML = `<a class="page-link" href="?page=${i}">${i}</a>`;
          if (i !== page) {
            pageItem.addEventListener('click', (event) => {
              event.preventDefault();
              loadTableData(i);
            });
          }
          paginationLinks.appendChild(pageItem);
        }

        // Next page link
        const nextPageItem = document.createElement('li');
        nextPageItem.className = 'page-item';
        nextPageItem.innerHTML = `
          <a class="page-link" href="?page=${page + 1}" aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
          </a>`;
        if (page < data.num_pages) {
          nextPageItem.addEventListener('click', (event) => {
            event.preventDefault();
            loadTableData(page + 1);
          });
        } else {
          nextPageItem.classList.add('disabled');
        }
        paginationLinks.appendChild(nextPageItem);

        // Last page link
        const lastPageItem = document.createElement('li');
        lastPageItem.className = 'page-item';
        lastPageItem.innerHTML = `<a class="page-link" href="?page=${data.num_pages}" aria-label="Last">Last</a>`;
        if (page < data.num_pages) {
          lastPageItem.addEventListener('click', (event) => {
            event.preventDefault();
            loadTableData(data.num_pages);
          });
        } else {
          lastPageItem.classList.add('disabled');
        }
        paginationLinks.appendChild(lastPageItem);
      });
  }

  // Load first page on page load
  loadTableData(1);

</script>

<script>
  function loadTableData(page) {
    fetch(`/pcwkb_core/gene_list/{{ species_id }}?page=${page}`)
      .then(response => response.json())
      .then(data => {
        const tableBody = document.getElementById('data-table').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = '';  // Clear current table data

        data.data.forEach(rowData => {
          const row = tableBody.insertRow();
          const cell1 = row.insertCell(0);
          cell1.innerHTML = `<a href="pcwkb_core/gene_page/${rowData.gene_name}">${rowData.gene_id}</a>`;
          const cell2 = row.insertCell(1);
          cell2.innerHTML =  `<a href="pcwkb_core/gene_page/${rowData.gene_name}">${rowData.gene_name}</a>`;
          const cell3 = row.insertCell(2);
          cell3.innerHTML = rowData.description;
        });

        // Handle pagination links
        const paginationLinks = document.getElementById('pagination-links2');
        paginationLinks.innerHTML = '';  // Clear current pagination links

        const maxPagesToShow = 5;  // Maximum number of page links to show
        let startPage = Math.max(1, page - Math.floor(maxPagesToShow / 2));
        let endPage = startPage + maxPagesToShow - 1;

        if (endPage > data.num_pages) {
          endPage = data.num_pages;
          startPage = Math.max(1, endPage - maxPagesToShow + 1);
        }

        // Frist page link
        const firstPageItem = document.createElement('li');
        firstPageItem.className = 'page-item';
        firstPageItem.innerHTML = `<a class="page-link" href="?page=1" aria-label="First">First</a>`;
        if (page > 1) {
          firstPageItem.addEventListener('click', (event) => {
            event.preventDefault();
            loadTableData(1);
          });
        } else {
          firstPageItem.classList.add('disabled');
        }
        paginationLinks.appendChild(firstPageItem);

        // Previous page link
        const prevPageItem = document.createElement('li');
        prevPageItem.className = 'page-item';
        prevPageItem.innerHTML = `
          <a class="page-link" href="?page=${page - 1}" aria-label="Previous">
            <span aria-hidden="true">&laquo;</span>
          </a>`;
        if (page > 1) {
          prevPageItem.addEventListener('click', (event) => {
            event.preventDefault();
            loadTableData(page - 1);
          });
        } else {
          prevPageItem.classList.add('disabled');
        }
        paginationLinks.appendChild(prevPageItem);

        // Page number links
        for (let i = startPage; i <= endPage; i++) {
          const pageItem = document.createElement('li');
          pageItem.className = `page-item ${i === page ? 'active disabled' : ''}`;
          pageItem.innerHTML = `<a class="page-link" href="?page=${i}">${i}</a>`;
          if (i !== page) {
            pageItem.addEventListener('click', (event) => {
              event.preventDefault();
              loadTableData(i);
            });
          }
          paginationLinks.appendChild(pageItem);
        }

        // Next page link
        const nextPageItem = document.createElement('li');
        nextPageItem.className = 'page-item';
        nextPageItem.innerHTML = `
          <a class="page-link" href="?page=${page + 1}" aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
          </a>`;
        if (page < data.num_pages) {
          nextPageItem.addEventListener('click', (event) => {
            event.preventDefault();
            loadTableData(page + 1);
          });
        } else {
          nextPageItem.classList.add('disabled');
        }
        paginationLinks.appendChild(nextPageItem);

        // Last page link
        const lastPageItem = document.createElement('li');
        lastPageItem.className = 'page-item';
        lastPageItem.innerHTML = `<a class="page-link" href="?page=${data.num_pages}" aria-label="Last">Last</a>`;
        if (page < data.num_pages) {
          lastPageItem.addEventListener('click', (event) => {
            event.preventDefault();
            loadTableData(data.num_pages);
          });
        } else {
          lastPageItem.classList.add('disabled');
        }
        paginationLinks.appendChild(lastPageItem);
      });
  }

  // Load first page on page load
  loadTableData(1);

</script>

{% endblock %}
